import time
import pandas as pd
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from bs4 import BeautifulSoup

def parse_ozon_reviews(product_url, category, max_reviews=30):
    """Парсит отзывы с товара Ozon"""
    
    # Настройка Selenium
    options = webdriver.ChromeOptions()
    options.add_argument('--headless')  # Фоновый режим
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
    driver.get(product_url)
    time.sleep(5)  # Увеличил время ожидания
    
    # Прокрутка и клик по кнопке "Показать ещё отзывы"
    for _ in range(3):
        try:
            more_button = driver.find_element(By.XPATH, '//button[contains(text(), "Показать ещё отзывы")]')
            driver.execute_script("arguments[0].click();", more_button)
            time.sleep(3)
        except Exception as e:
            print(f"Не удалось найти кнопку: {e}")
            break
    
    # Парсинг HTML
    soup = BeautifulSoup(driver.page_source, 'html.parser')
    reviews = soup.find_all('div', {'class': 'review'})
    
    data = []
    for review in reviews[:max_reviews]:
        try:
            # Парсинг рейтинга
            rating_elem = review.find('div', {'class': 'rating'})
            rating = int(rating_elem.get('style').split(':')[-1].replace('%', '').strip())
            rating = round(rating / 20)  # Конвертация в 1-5 звёзд
            
            # Парсинг текста
            text_elem = review.find('div', {'class': 'text'})
            text = text_elem.get_text(strip=True) if text_elem else ''
            
            # Парсинг даты
            date_elem = review.find('span', {'class': 'date'})
            date = date_elem.get_text(strip=True) if date_elem else ''
            
            # Парсинг лайков
            likes_elem = review.find('span', {'class': 'like-count'})
            likes = int(likes_elem.get_text(strip=True)) if likes_elem else 0
            
            # Парсинг атрибутов товара
            attributes = review.find('div', {'class': 'attributes'})
            size = color = ''
            if attributes:
                for attr in attributes.find_all('span'):
                    if 'Размер' in attr.text:
                        size = attr.text.replace('Размер:', '').strip()
                    elif 'Цвет' in attr.text:
                        color = attr.text.replace('Цвет:', '').strip()
            
            data.append({
                'product_url': product_url,
                'category': category,
                'rating': rating,
                'text': text,
                'date': date,
                'likes': likes,
                'size': size,
                'color': color
            })
        except Exception as e:
            print(f"Ошибка при парсинге отзыва: {e}")
    
    driver.quit()
    return pd.DataFrame(data)

if __name__ == "__main__":
    # Актуальные URL товаров (проверено 2023-11-15)
    products = [
        {"url": "https://www.ozon.ru/product/futbolka-muzhskaya-chelsi-polo-ts-2301-chernyy-razmer-m-361151181/", "category": "men"},
        {"url": "https://www.ozon.ru/product/rubashka-muzhskaya-letnyaya-s-korotkim-rukvom-razmer-50-52-686315126/", "category": "men"},
        {"url": "https://www.ozon.ru/product/dzheynsovaya-rubashka-muzhskaya-osen-2023-razmer-50-52-715420032/", "category": "men"},
        {"url": "https://www.ozon.ru/product/plate-zhenskoe-letnee-s-tsvetochnym-printom-razmer-42-44-428595224/", "category": "women"},
        {"url": "https://www.ozon.ru/product/bluzka-zhenskaya-s-tsvetochnym-printom-razmer-42-44-725685332/", "category": "women"}
    ]
    
    all_reviews = pd.DataFrame()
    
    for product in products:
        print(f"Парсинг товара: {product['url']}")
        reviews = parse_ozon_reviews(product['url'], product['category'], max_reviews=20)
        all_reviews = pd.concat([all_reviews, reviews], ignore_index=True)
        time.sleep(10)  # Пауза между запросами
    
    # Разделение данных по категориям
    men_reviews = all_reviews[all_reviews['category'] == 'men']
    women_reviews = all_reviews[all_reviews['category'] == 'women']
    
    # Сохранение в CSV
    men_reviews.to_csv('data/ozon_reviews_men.csv', index=False)
    women_reviews.to_csv('data/ozon_reviews_women.csv', index=False)
    
    print(f"\nИтоговый сбор данных:")
    print(f"- Мужские товары: {len(men_reviews)} отзывов")
    print(f"- Женские товары: {len(women_reviews)} отзывов")
    print(f"- Всего отзывов: {len(all_reviews)}")
